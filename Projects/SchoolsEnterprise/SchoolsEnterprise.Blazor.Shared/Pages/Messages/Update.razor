@page "/messages/{MessageId}"

@using ConectOne.Blazor.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.Extensions.Configuration
@using MudBlazor
@using Radzen.Blazor

@attribute [Authorize]

<MudGrid>
    <MudItem md="6">
        <DefaultTitle Title="Update Message" Caption="@($"Complete the following information to update message")" />
    </MudItem>
    <MudItem md="6">
        <MudBreadcrumbs Items="_items" Style="@("float:right")"></MudBreadcrumbs>
    </MudItem>
</MudGrid>

<EditForm Model="_notificationMessage" OnValidSubmit="UpdateAsync">
    <DataAnnotationsValidator />
    <MudGrid>
        <MudItem xs="12" sm="12">
            <MudCard>
                <MudCardContent>
                    <MudGrid>
                        <MudItem md="12">
                            <MudTextField Label="@("Notification Title")" Class="@("mt-3")" @bind-Value="_notificationMessage.Subject" For="@(() => _notificationMessage.Subject)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem md="12">
                            <MudTextField Lines="4" Label="@("Short Description")" Class="@("mt-3")" @bind-Value="_notificationMessage.ShortDescription" For="@(() => _notificationMessage.ShortDescription)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem md="12">
                            <RadzenHtmlEditor @bind-Value=@_notificationMessage.Message style="height: 450px;" />
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem md="12">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Document Links to Include</MudText>
                </MudCardHeader>
                <MudCardContent>
                    @if (_notificationMessage.DocumentLinks.Any())
                    {
                        <MudList T="string" Dense="@true" DisableGutters="false">
                            @foreach (var item in _notificationMessage.DocumentLinks)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Attachment" OnClick="@(() => OpenMessageLink(item))">@(string.IsNullOrEmpty(item.Split("/").Last()) ? item.Split("/")[item.Split("/").Length - 2] : item.Split("/").Last())<MudButton Style="@("float:right")" OnClick="@(() => RemoveDocumentLink(item))" Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" Class="@("ml-auto")">Delete</MudButton></MudListItem>
                            }
                        </MudList>
                    }
                    @if (_notificationMessage.Documents.Any())
                    {
                        <MudList T="string" Dense="@true" DisableGutters="false">
                            @foreach (var item in _notificationMessage.Documents)
                            {
                                <MudListItem Icon="@Icons.Material.Filled.Attachment" OnClick="@(() => OpenMessageLink(Configuration.GetValue<string>("ApiConfiguration:BaseApiAddress")+"/"+item.Url))">@item.FileName<MudButton Style="@("float:right")" OnClick="@(() => RemoveDocument(item.Url))" Size="Size.Small" Variant="Variant.Filled" Color="Color.Error" Class="@("ml-auto")">Delete</MudButton></MudListItem>
                            }
                        </MudList>
                    }
                    <MudButton OnClick="CreateNotificationLinkAsync" Variant="Variant.Filled" Color="Color.Tertiary" Class="@("ml-auto")" FullWidth>Create New Link</MudButton>
                </MudCardContent>
            </MudCard>
        </MudItem>
        
        <MudItem xs="12" sm="12" md="4" lg="4">
            <MudButton OnClick="UpdateAndSendAsync" Variant="Variant.Filled" Color="Color.Info" Class="@("ml-auto")" FullWidth>Save & Send</MudButton>
        </MudItem>

        <MudItem xs="12" sm="12" md="4" lg="4">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="@("ml-auto")" FullWidth>Save</MudButton>
        </MudItem>

        <MudItem xs="12" sm="12" md="4" lg="4">
            <MudButton OnClick="Cancel" Variant="Variant.Filled" Color="Color.Secondary" Class="@("ml-auto")" FullWidth>Cancel</MudButton>
        </MudItem>
    </MudGrid>
</EditForm>