@page "/parents/update/{ParentId}"
@using ConectOne.Blazor.Components
@using ConectOne.Blazor.Components.ContactNumbers
@using ConectOne.Blazor.Components.EmailAddresses
@using FilingModule.Blazor.Modals
@using FilingModule.Domain.Enums
@using MessagingModule.Blazor.Components.Messages
@using MessagingModule.Blazor.Components.Notifications
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using NeuralTech.Base.Enums
@using SchoolsModule.Blazor.Components.Learners
@using SchoolsModule.Domain.Entities

@attribute [Authorize]

<EditForm Model="_parent" OnValidSubmit="UpdateAsync">
    <MudGrid>
        <MudItem md="6">
            <DefaultTitle Title="@($"Update {_parent?.FirstName} {_parent?.LastName}")" Caption="Complete or change to update parent information" />
        </MudItem>
        <MudItem md="6" Style="float:right">
            <MudBreadcrumbs Items="_items" Style="float:right"></MudBreadcrumbs>
        </MudItem>

        <MudItem md="12">
            <DataAnnotationsValidator />

            <MudTabs>
                <!-- DETAILS TAB -->
                <MudTabPanel Text="Details">
                    <MudGrid>
                        <!-- Left Column: Profile Image Upload -->
                        <MudItem xs="12" sm="12" md="3" lg="3">
                            <MudSingleImageCropperUpload OnFileAccepted="CoverImageChanged" Caption="@($"{_parent.FirstName} {_parent.LastName}")" Src="@_imageSource" ImageType="UploadType.Cover" Entity="typeof(Parent)" ParentId="@_parent.ParentId" />
                        </MudItem>

                        <!-- Right Column: Personal & Contact Info -->
                        <MudItem xs="12" sm="12" md="9" lg="9">
                            <MudCard>
                                <MudCardHeader>
                                    <MudText Align="Align.Center" Typo="Typo.h6">Personal Information</MudText>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudGrid>
                                        <!-- Basic parent details: first, middle, and last name. -->
                                        <MudItem md="4">
                                            <MudTextField Label="First Name" Class="mt-3" @bind-Value="_parent.FirstName" For="@(() => _parent.LastName)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>

                                        <MudItem md="4">
                                            <MudTextField Label="Middle Names" Class="mt-3" @bind-Value="_parent.MiddleName" For="@(() => _parent.MiddleName)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>

                                        <MudItem md="4">
                                            <MudTextField Label="Last Name" Class="mt-3" @bind-Value="_parent.LastName" For="@(() => _parent.LastName)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>

                                        <MudDivider />

                                        <!-- Contact Numbers (Phone) -->
                                        <MudItem xs="12" sm="12" md="6" lg="6">
                                            @if (!string.IsNullOrEmpty(_parent.ParentId))
                                            {
                                                <MudCard>
                                                    <ContactNumberList TContactNumberOwner="Parent" ParentId="@_parent.ParentId" ControllerUrlPart="parents" />
                                                </MudCard>
                                            }
                                        </MudItem>

                                        <!-- Email Addresses -->
                                        <MudItem xs="12" sm="12" md="6" lg="6">
                                            @if (!string.IsNullOrEmpty(_parent.ParentId))
                                            {
                                                <MudCard>
                                                    <EmailAddressList TEmailAddressOwner="Parent" ParentId="@_parent.ParentId" ControllerPartUrl="parents" />
                                                </MudCard>
                                            }
                                        </MudItem>

                                        <MudItem xs="12">
                                            <MudDivider Class="my-2" />
                                            <MudText Typo="Typo.subtitle1">Medical Information</MudText>
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudTextField T="string" Label="Emergency Medical Info" Variant="Variant.Outlined" @bind-Value="_parent.EmergencyMedicalInfo" Lines="3" Margin="Margin.Dense" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Medical Aid Provider" Class="mt-3" @bind-Value="_parent.MedicalAidProvider" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Medical Aid Plan" Class="mt-3" @bind-Value="_parent.MedicalAidPlan" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Medical Aid Number" Class="mt-3" @bind-Value="_parent.MedicalAidNumber" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Medical Aid Main Member" Class="mt-3" @bind-Value="_parent.MedicalAidMainMember" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Main Member ID Number" Mask="@(new PatternMask("000000 0000 000"))" Class="mt-3" @bind-Value="_parent.MedicalAidMainMemberIdNumber" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Primary Physician" Class="mt-3" @bind-Value="_parent.PrimaryPhysicianName" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem xs="12" sm="6" md="4">
                                            <MudTextField Label="Physician Contact Number" Class="mt-3" @bind-Value="_parent.PrimaryPhysicianContactNumber" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- DEPENDANTS TAB -->
                <MudTabPanel Text="Dependants">
                    <LearnersTable LearnerRemoved="OnLearnerRemoved" MultiSelectionChanged="OnMultiSelectionChanged" ServerData="ServerReload" SelectedPagedLearners="_selectedPagedLearners" ParentId="@_parent.ParentId"
                                   UseModal="true" LearnerCreated="OnLearnerCreated" Search="OnLearnerSearh" LearnerSelectionChanged="OnLearnerSelectionChanged"/>
                </MudTabPanel>

                <!-- SETTINGS TAB -->
                <MudTabPanel Text="Settings">
                    <MudGrid>
                        <!-- Toggles for various parent preferences: consent, messages, notifications, emails -->
                        <MudItem xs="3">
                            <MudSwitch @bind-Value="@_parent.RequireConsent"
                                       Color="Color.Secondary"
                                       Style="margin-left: 5px;">
                                Require Consent
                            </MudSwitch>
                        </MudItem>
                        <MudItem xs="3">
                            <MudSwitch @bind-Value="@_parent.ReceiveMessages"
                                       Color="Color.Secondary"
                                       Style="margin-left: 5px;">
                                Receive Messages
                            </MudSwitch>
                        </MudItem>
                        <MudItem xs="3">
                            <MudSwitch @bind-Value="@_parent.ReceiveNotifications"
                                       Color="Color.Secondary"
                                       Style="margin-left: 5px;">
                                Receive Notifications
                            </MudSwitch>
                        </MudItem>
                        <MudItem xs="3">
                            <MudSwitch @bind-Value="@_parent.ReceiveEmails"
                                       Color="Color.Secondary"
                                       Style="margin-left: 5px;">
                                Receive Emails
                            </MudSwitch>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- DEVICES TAB (currently empty, for future device management) -->
                <MudTabPanel Text="Devices">
                </MudTabPanel>

                <!-- NOTIFICATIONS TAB -->
                @* @if (_userInfo is not null)
                { *@
                    <MudTabPanel Text="Notifications">
                        <NotificationsTable ReceiverId="@ParentId" />
                    </MudTabPanel>
                @* } *@
                
                <MudTabPanel Text="Messages">
                    <MessagesTable MessageType="(int)MessageType.Parent" EntityId="@ParentId" ></MessagesTable>
                </MudTabPanel>
            </MudTabs>
        </MudItem>

        <!-- Save & Cancel Buttons -->
        <MudItem xs="6" sm="6" md="6" lg="6">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" FullWidth>
                Save
            </MudButton>
        </MudItem>

        <MudItem xs="6" sm="6" md="6" lg="6">
            <MudButton OnClick="Cancel" Variant="Variant.Filled" Color="Color.Secondary" Class="ml-auto" FullWidth>
                Cancel
            </MudButton>
        </MudItem>
    </MudGrid>
</EditForm>
