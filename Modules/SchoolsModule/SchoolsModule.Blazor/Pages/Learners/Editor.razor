@page "/learners/update/{LearnerId}"
@using ConectOne.Blazor.Components
@using ConectOne.Blazor.Components.ContactNumbers
@using ConectOne.Blazor.Components.EmailAddresses
@using ConectOne.Domain.Enums
@using FilingModule.Blazor.Modals
@using FilingModule.Domain.Enums
@using MessagingModule.Blazor.Components.Messages
@using MessagingModule.Blazor.Components.Notifications
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@using NeuralTech.Base.Enums
@using SchoolsModule.Blazor.Components.ActivityGroups
@using SchoolsModule.Domain.DataTransferObjects
@using SchoolsModule.Domain.Entities

@attribute [Authorize]

<EditForm Model="_learner" OnValidSubmit="UpdateAsync">
    <MudGrid>
        <MudItem md="6">
            <DefaultTitle Title="@($"Update {_learner?.FirstName} {_learner?.LastName}")" Caption="Complete or change to update learner information" />
        </MudItem>
        <MudItem md="6" Style="float:right">
            <MudBreadcrumbs Items="_items" Style="float:right"></MudBreadcrumbs>
        </MudItem>
        <MudItem md="12">
            
            <DataAnnotationsValidator/>
            <ValidationSummary/>

            <MudTabs>
                <MudTabPanel Text="Details">
                    <MudGrid>
                        <MudItem xs="12" sm="12" md="3" lg="3">
                            <MudSingleImageCropperUpload OnFileAccepted="CoverImageChanged" Caption="@($"{_learner.FirstName} {_learner.LastName}")" Src="@_imageSource" ImageType="UploadType.Cover" Entity="typeof(Learner)" ParentId="@_learner.LearnerId"/>
                            <MudDivider/>
                            <MudCard>
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem md="12">
                                            <MudSelect T="Gender" Label="Gender" @bind-Value="@_learner.Gender" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" ToStringFunc="@(contactMomentType => contactMomentType.ToString())" Margin="Margin.Dense">
                                                @foreach (var state in (Gender[])Enum.GetValues(typeof(Gender)))
                                                {
                                                    <MudSelectItem Value="@state">@state.ToString()</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                        <MudItem md="12">
                                            <MudSelect T="SchoolGradeDto" ToStringFunc="@_schoolGradeConverter" Label="Grade" Value="@_learner.SelectedGrade" ValueChanged="SelectedGradeChanged" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                @foreach (var state in AvailableGrades)
                                                {
                                                    <MudSelectItem Value="@state">@state.SchoolGrade</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                        <MudItem md="12">
                                            <MudSelect ToStringFunc="@_availableSchoolConverter" Label="Class" @bind-Value="@_learner.SelectedSchoolClass" AnchorOrigin="Origin.BottomCenter" Variant="Variant.Outlined" Margin="Margin.Dense">
                                                @foreach (var state in AvailableSchoolClasses)
                                                {
                                                    <MudSelectItem Value="@state">@state.SchoolClass</MudSelectItem>
                                                }
                                            </MudSelect>
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>

                        <MudItem xs="12" sm="12" md="9" lg="9">
                            <MudCard>
                                <MudCardHeader>
                                    <MudText Align="Align.Center" Typo="Typo.h6">Personal Information</MudText>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem md="4">
                                            <MudTextField Label="First Name" Class="mt-3" @bind-Value="_learner.FirstName" For="@(() => _learner.LastName)" Margin="Margin.Dense" Variant="Variant.Outlined"/>
                                        </MudItem>
                                        <MudItem md="4">
                                            <MudTextField Label="Middle Names" Class="mt-3" @bind-Value="_learner.MiddleNames" For="@(() => _learner.MiddleNames)" Margin="Margin.Dense" Variant="Variant.Outlined"/>
                                        </MudItem>
                                        <MudItem md="4">
                                            <MudTextField Label="Last Name" Class="mt-3" @bind-Value="_learner.LastName" For="@(() => _learner.LastName)" Margin="Margin.Dense" Variant="Variant.Outlined"/>
                                        </MudItem>

                                        <MudItem md="8">
                                            <MudTextField Mask="@(new PatternMask("000000 0000 000"))" Label="Identity Nr" Class="mt-3" @bind-Value="_learner.IdNumber" For="@(() => _learner.IdNumber)" Margin="Margin.Dense" Variant="Variant.Outlined" />
                                        </MudItem>
                                        <MudItem md="4">
                                            <MudTextField Disabled="true" Label="Date Of Birth" Class="mt-3" Value="_learner.DateOfBirth" Margin="Margin.Dense" Variant="Variant.Outlined"/>
                                        </MudItem>


                                        <MudDivider/>

                                        <MudItem xs="12" sm="12" md="6" lg="6">
                                            @if (_learner.LearnerId is not null)
                                            {
                                                <MudCard>
                                                    <ContactNumberList TContactNumberOwner="Learner" ParentId="@_learner.LearnerId" ControllerUrlPart="learners"/>
                                                </MudCard>
                                            }
                                            else
                                            {
                                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
                                            }

                                        </MudItem>
                                        <MudItem xs="12" sm="12" md="6" lg="6">
                                            @if (_learner.LearnerId is not null)
                                            {
                                                <MudCard>
                                                    <EmailAddressList TEmailAddressOwner="Learner" ParentId="@_learner.LearnerId" ControllerPartUrl="learners"/>
                                                </MudCard>
                                            }
                                            else
                                            {
                                                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-7"/>
                                            }
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>
                
                <MudTabPanel Text="Medical Info">
                    <MudGrid>
                        <MudItem xs="12" sm="12" md="11" lg="9">
                            <MudCard>
                                <MudCardHeader>
                                    <MudText Align="Align.Center" Typo="Typo.h6">Medical Information</MudText>
                                </MudCardHeader>
                                <MudCardContent>
                                    <MudGrid>
                                        <MudItem xs="12">
                                            <MudAlert Severity="Severity.Info">
                                                Medical aid details are managed on the parent's profile. Select the parent whose medical aid should be used for this learner.
                                            </MudAlert>
                                        </MudItem>
                                        <MudItem xs="12" md="6">
                                            <MudSelect ToStringFunc="_parentConverter" Placeholder="No parent selected" T="ParentDto" Label="Medical Aid Parent" @bind-Value="_learner.MedicalAidParent" Variant="Variant.Outlined" Margin="Margin.Dense" AnchorOrigin="Origin.BottomCenter">
                                                @if (_selectedParents is not null)
                                                {
                                                    foreach (var parent in _selectedParents)
                                                    {
                                                        <MudSelectItem Value="@parent">@parent.FirstName @parent.LastName</MudSelectItem>
                                                    }
                                                }
                                            </MudSelect>
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudTextField Label="Additional Medical Notes" Class="mt-3" @bind-Value="_learner.MedicalNotes" For="@(() => _learner.MedicalNotes)" Variant="Variant.Outlined" Margin="Margin.Dense" Lines="4" TextFieldType="TextFieldType.Multiline" />
                                        </MudItem>
                                    </MudGrid>
                                </MudCardContent>
                            </MudCard>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <MudTabPanel Text="Parents">
                    <SchoolsModule.Blazor.Components.Parents.ParentsTableV2 SelectedParents="_selectedParents" OnSelectionChange="OnValueSelectionChanged" LearnerId="@_learner.LearnerId"/>
                </MudTabPanel>

                <MudTabPanel Text="ActivityGroups">
                    <ActivityGroupTableV2 LearnerId="@_learner.LearnerId" ShowLinkActivityGroupButtons="false"/>
                </MudTabPanel>

                <MudTabPanel Text="Discipline">
                    <SchoolsModule.Blazor.Components.Discipline.LearnerDisciplinaryHistory LearnerId="@LearnerId"/>
                </MudTabPanel>

                @if (_userInfo is not null)
                {
                    <MudTabPanel Text="Notifications">
                        <NotificationsTable ReceiverId="@LearnerId"></NotificationsTable>
                    </MudTabPanel>

                    <MudTabPanel Text="Messages">
                        <MessagesTable MessageType="(int)MessageType.Learner" EntityId="@LearnerId"></MessagesTable>
                    </MudTabPanel>
                }

            </MudTabs>

        </MudItem>
        <MudItem xs="6" sm="6" md="6" lg="6">
            <MudButton ButtonType="ButtonType.Submit" Variant="Variant.Filled" Color="Color.Primary" Class="ml-auto" FullWidth>Save</MudButton>
        </MudItem>
    
        <MudItem xs="6" sm="6" md="6" lg="6">
            <MudButton OnClick="Cancel" Variant="Variant.Filled" Color="Color.Secondary" Class="ml-auto" FullWidth>Cancel</MudButton>
        </MudItem>
    </MudGrid>
</EditForm>