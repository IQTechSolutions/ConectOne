@using System.Diagnostics.CodeAnalysis
@using Microsoft.JSInterop

@inject IJSRuntime JS

@typeparam T 

<div id="@Id">
    @foreach (var item in Items)
    {
        @if (SortableItemTemplate is not null)
        {
            @SortableItemTemplate(item)
        }
    }
</div>

@code {

    [Parameter] public RenderFragment<T>? SortableItemTemplate { get; set; }

    [Parameter, AllowNull] public List<T> Items { get; set; }

    [Parameter] public EventCallback<(int oldIndex, int newIndex, List<T>)> OnUpdate { get; set; }

    [Parameter] public EventCallback<(int oldIndex, int newIndex, string id)> OnRemove { get; set; }
    [Parameter] public EventCallback<(int oldIndex, int newIndex, string id)> OnAdd { get; set; }
    [Parameter] public EventCallback<(int oldIndex, T item)> OnStart { get; set; }

    [Parameter] public string Id { get; set; } = Guid.NewGuid().ToString();

    [Parameter] public string Group { get; set; } = Guid.NewGuid().ToString();

    [Parameter] public string? Pull { get; set; }

    [Parameter] public bool Put { get; set; } = true;

    [Parameter] public bool Sort { get; set; } = true;

    [Parameter] public string Handle { get; set; } = string.Empty;

    [Parameter] public string? Filter { get; set; }

    [Parameter] public bool ForceFallback { get; set; } = true;

    private DotNetObjectReference<SortableList2<T>>? selfReference;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            selfReference = DotNetObjectReference.Create(this);
            var module = await JS.InvokeAsync<IJSObjectReference>("import", "./_content/NeuralTech.Blazor/Components/SortableItems/SortableList2.razor.js");
            await module.InvokeAsync<string>("init", Id, Group, Pull, Put, Sort, Handle, Filter, selfReference, ForceFallback);
        }
    }

    [JSInvokable] public void OnUpdateJS(int oldIndex, int newIndex)
    {
        // invoke the OnUpdate event passing in the oldIndex and the newIndex
        OnUpdate.InvokeAsync((oldIndex, newIndex, Items));
    }

    [JSInvokable] public void OnRemoveJS(int oldIndex, int newIndex, string id)
    {
        // remove the item from the list
        OnRemove.InvokeAsync((oldIndex, newIndex, id));
    }

    [JSInvokable] public void OnAddJS(int oldIndex, int newIndex, string id)
    {
        // remove the item from the list
        OnAdd.InvokeAsync((oldIndex, newIndex, id));
    }

    [JSInvokable] public void OnStartJS(int oldIndex, string id)
    {
        // remove the item from the list
        OnStart.InvokeAsync((oldIndex,Items[oldIndex]));
    }

    public void Dispose() => selfReference?.Dispose();
}